{% extends "base_template.html" %}

{% block title %}Modelr &middot; Dashboard{% endblock %}

{% block content %}

<div class="container">

  <ul class="nav nav-tabs">
    <li class="active"><a href="#feed" data-toggle="tab">Feed</a></li>
    <li><a href="#scenarios" data-toggle="tab">Scenarios</a></li>
    <li><a href="#models" data-toggle="tab">Models</a></li>
    <li><a href="#rocks" data-toggle="tab">Rocks</a></li>
  </ul>
    
  <div class="tab-content">

    <!-- +++++++++ FEED TAB CONTENT +++++++++ -->
    <div class="tab-pane active" id="feed">
      <div class="col-md-6">
            <h2>Welcome to Modelr!</h2>
            <p class="lead"> To get started, try our <a href="/model">model</a> or <a href="/scenario">scenario</a> pages. Use the tabs on the right to manage your rocks and models!</p>
            <p class="lead"><a href="/help">Need more help?</a></p>
      </div>
    </div>

    <!-- +++++++++ SCENARIOS TAB CONTENT +++++++++ -->
    <div class="tab-pane" id="scenarios">
      <h2>Scenarios</h2>

      <table class="table table-condensed table-hover">
        <tbody>

          {% for scenario in scenarios %}
            <tr id="{{scenario.name}}">
                <td><strong><a href='/scenario#{{scenario.name}}'>{{scenario.name}}</a></strong></td>
                <td>{{scenario.script}}</td>
                <td> <a class="btn btn-success btn-xs" href="/scenario#{{scenario.name}}" > edit&nbsp;</a> &nbsp;&nbsp;<button class="btn btn-danger btn-xs" type="button" onclick='delete_scenario("{{scenario.name}}")'>delete</button></td>
		
	    </tr>
          {% endfor %}
        </tbody>
      </table>

      <a class="btn btn-primary" href="/scenario" role="button">Make a new scenario</a>
    </div>

    <!-- +++++++++ MODELS TAB CONTENT +++++++++ -->
    <div class="tab-pane" id="models">

      <h2>Models</h2>
      <p>Manage your uploaded images and saved models.</p>
      <div class="alert alert-warning">
        <strong>Note:</strong> Deleting an image will remove all associated models.
      </div>

      <hr />

      {% for img in models %}
      <div class="row" id="{{img['image_key']}}">

        <div class="col-lg-3 col-md-3">
        
          <a href="/model#image_key={{img['image_key']}}">
            <img class="img-rounded" src="{{img['image']}}" alt="" >
          </a>
    
          <a class="btn btn-success btn-xs" href="/model#image_key={{img['image_key']}}">open image</a>

          {% if img.editable %}
            <button class="btn btn-danger btn-xs" onclick='delete_image("{{img['image_key']}}")'>delete image</button>
          {% endif %}
    
    
        </div>

        <div class="col-lg-5 col-md-5">
        
          <tr>
            {% for model in img["models"] %}
              <div class="row">
                <td><strong><a href="/model#image_key={{img['image_key']}}&name={{model.name}}">{{model.name}}</a></strong></td>
                <td> <a class="btn btn-success btn-xs" href="/model#image_key={{img['image_key']}}&name={{model.name}}" > open&nbsp;</a> &nbsp;&nbsp;</td>
                <button class="btn btn-danger btn-xs" onclick='delete_model("{{img['image_key']}}","{{model.name}}", this.parentNode)'>delete</button>
              </div>
            {% endfor%}
          </tr>
        </div>

      </div>

      <hr />
      {% endfor %}
    </div> <!-- /tab -->

    <!-- +++++++++ ROCKS TAB CONTENT +++++++++ -->
    <div class="tab-pane" id="rocks">

      <!-- ------ My rocks table ------- -->
      <h2>My rocks</h2>
      <table class="table table-condensed table-hover">
        <thead>
          <tr>
            <th></th>
            <th><em>V</em><sub>P</sub></th>
            <th><em>V</em><sub>S</sub></th>
            <th><em>ρ</em></th>
            <th><em>V</em><sub>P</sub> SD</th>
            <th><em>V</em><sub>S</sub> SD</th>
            <th><em>ρ</em> SD</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for rock in rocks %}

          {% set slug  = rock.name | replace(' ','-') %}

          <tr>
            <form class="form-horizontal" name="input" action="edit_rock" method="post">
              <input type="hidden" name="name" value="{{rock.name}}" />
              <td><strong>{{ rock.name }}</strong><span style="color:#bbb; font-size:100%; vertical-align:middle; left:6px; top:-2px;" class="glyphicon glyphicon-info-sign" id="rock_desc_{{ slug }}" data-container="body" data-toggle="popover" data-placement="right" data-content="{{ rock.description }}"></td>
              <td>{{rock.vp}}</td>
              <td>{{rock.vs}}</td>
              <td>{{rock.rho}}</td>
              <td>{{rock.vp_std}}</td>
              <td>{{rock.vs_std}}</td>
              <td>{{rock.rho_std}}</td>
              <td><input class="btn btn-success btn-xs" type="submit" name="action" value="edit">&nbsp;&nbsp;&nbsp;&nbsp;<input class="btn btn-danger btn-xs" type="submit" formaction="/remove_rock" method="post" value="remove" /></td>
            </form>
          </tr>

      <script>
        $('#rock_desc_{{ slug }}').popover({
        trigger: 'hover click', 
        html: true,
        placement: 'right', 
        container: 'body',
        delay: { show: 500, hide: 1000 }
        });
      </script>

          {% endfor %}
        </tbody>
      </table>


      <!-- ------ Shared rocks, if any ------- -->
      {% for rock_group in rock_groups %}
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">{{rock_group['name']}} rocks</h3>
        </div>
        <div class="panel-body">
          <table class="table table-condensed table-hover">
            <thead>
              <tr>
                <th></th>
                <th><em>V</em><sub>P</sub></th>
                <th><em>V</em><sub>S</sub></th>
                <th><em>ρ</em></th>
                <th><em>V</em><sub>P</sub> SD</th>
                <th><em>V</em><sub>S</sub> SD</th>
                <th><em>ρ</em> SD</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for rock in rock_group['rocks'] %}
              <tr>
                <input type="hidden" name="name" value="{{rock.name}}" />
                <td><strong>{{rock.name}}</strong></td>
                <td>{{rock.vp}}</td>
                <td>{{rock.vs}}</td>
                <td>{{rock.rho}}</td>
                <td>{{rock.vp_std}}</td>
                <td>{{rock.vs_std}}</td>
                <td>{{rock.rho_std}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}

      <!-- ------ Default rocks ------- -->
      <div class="panel panel-default" id="accordion">
        <div class="panel-heading">
          <h3 class="panel-title"><a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseDefault" data-toggle="collapse">
          <i class="indicator glyphicon glyphicon-chevron-down pull-right" style="color:gray;"></i> Default rocks</a>
          </h3>
        </div>
        <div class="panel-body panel-collapse collapse" id="collapseDefault">
          <table class="table table-condensed table-hover">
            <thead>
              <tr>
                <th></th>
                <th><em>V</em><sub>P</sub></th>
                <th><em>V</em><sub>S</sub></th>
                <th><em>ρ</em></th>
                <th><em>V</em><sub>P</sub> SD</th>
                <th><em>V</em><sub>S</sub> SD</th>
                <th><em>ρ</em> SD</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for rock in default_rocks %}
              <tr>
                <input type="hidden" name="name" value="{{rock.name}}" />
                <td><strong>{{rock.name}}</strong></td>
                  <td>{{rock.vp}}</td>
                  <td>{{rock.vs}}</td>
                  <td>{{rock.rho}}</td>
                  <td>{{rock.vp_std}}</td>
                  <td>{{rock.vs_std}}</td>
                  <td>{{rock.rho_std}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div> <!-- end of panel body -->
      </div> <!-- end of panel -->

      <!-- ------ Add a rock ------- -->
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Add rock</h3>
        </div>
        <div class="panel-body">
          <form class="form-horizontal" role="form" name="input" method="post">

            <div class="row"> <!-- NAME -->
              <div class="form-group">
                <label for="name" class="col-sm-2 control-label">Name</label>
                <div class="col-sm-9">
                  <input class="form-control" type="text" name="name" value="{{current_rock.name}}" />
                </div>
              </div>
            </div> <!-- /row -->

            <div class="row"> <!-- DESCRIPTION -->
              <div class="form-group">
                <label for="description" class="col-sm-2 control-label">Description</label>
                <div class="col-sm-9">
                  <textarea class="form-control" rows="2" name="description">{{ current_rock.description }}</textarea>
                </div>
              </div>
            </div> <!-- /row -->

            <div class="row"> <!-- Properties ROW -->

              <div class="col-sm-6"> <!-- LEFT COLUMN -->

                <div class="form-group">
                  <label for="vp" class="col-sm-4 control-label"><em>V</em><sub>P</sub></label>
                  <div class="col-sm-6">
                    <input class="form-control" type="text" name="vp" value="{{current_rock.vp}}" />
                  </div>
                 </div>

                <div class="form-group">
                  <label for="vs" class="col-sm-4 control-label"><em>V</em><sub>S</sub></label>
                  <div class="col-sm-6">
                    <input class="form-control" type="text" name="vs" value="{{current_rock.vs}}"  />
                  </div>
                </div>

                <div class="form-group">
                  <label for="rho" class="col-sm-4 control-label"><em>ρ</em></label>
                  <div class="col-sm-6">
                    <input class="form-control" type="text" name="rho" value="{{current_rock.rho}}" />
                  </div>
                </div>

              </div> <!-- /column -->

              <div class="col-sm-offset-6 col-sm-6 form-group"> <!-- RIGHT COLUMN -->

                <div class="form-group">
                  <label for="vp std" class="col-sm-4 control-label"><em>V</em><sub>P</sub> SD</label>
                  <div class="col-sm-6">
                    <input class="form-control" type="text" name="vp_std" value="{{current_rock.vp_std}}" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="vs std" class="col-sm-4 control-label"><em>V</em><sub>S</sub> SD</label>
                  <div class="col-sm-6">
                    <input class="form-control" type="text" name="vs_std" value="{{current_rock.vs_std}}" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="rho std" class="col-sm-4 control-label"><em>ρ</em> SD</label>
                  <div class="col-sm-6">
                    <input class="form-control" type="text" name="rho_std" value="{{current_rock.rho_std}}" />
                  </div>
                </div>

              </div> <!-- /column -->

            </div> <!-- /row -->

            <div class="row"> <!-- SHARE ROW -->
              <div class="form-group">
                <label for="sharing" class="col-sm-2 control-label">Share</label>
                <div class="col-sm-9">
                  <select class="form-control" name="group">
                    <option value="private">Private</option>
                    {% for group in user.group %}
                    <option value={{group}} {% if group==current_rock.group %} selected {% endif %}>{{group.capitalize()}}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div> <!-- /row -->
    
            <div class="row"> <!-- BUTTON ROW -->
              <div class="form-group">
                <div class="col-sm-offset-2 col-sm-6">
                  <button type="submit" class="btn btn-primary">Add this rock</button>
                  <button type="reset" class="btn btn-default">Reset form</button>
                </div>
              </div>
            </div> <!-- /row -->
    
          </form>


        </div> <!-- end of panel body -->
      </div> <!-- end of panel  -->
    </div> <!-- /tab  -->

    </div> <!-- end all of tab content  -->

    <!-- +++++++++ END OF TAB CONTENT +++++++++ -->

</div>

<script>

// Show tabs on clicking
$('.tabbable .nav-tabs a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
  });
  

function delete_scenario(scenario){

   cb = function(data){
    var elem = document.getElementById(scenario);
    elem.parentNode.removeChild(elem);
   };

   $.ajax('/scenario_db?name='+scenario, {type: "DELETE",
					  success: cb});
 };

function delete_model(image_key, model_name, element){

   callback = function(data){


     if (JSON.parse(data)["success"]){
   element.parentNode.removeChild(element);
   };
   };

   $.ajax('/earth_model?input_image_id=' + image_key + '&' + 'name=' + model_name,
    {type: "DELETE",
     success: callback});
 };

function delete_image(image_key){

   callback = function(data){

    var elem = document.getElementById(image_key);
    elem.parentNode.removeChild(elem);
   }
  
   $.ajax('/image_model?image_key=' + image_key, {type:"DELETE",
              success: callback});

};


</script>

<script>
 $(document).ready(function() {
   

   var activeTab = $('[href=' + location.hash + ']');
   activeTab && activeTab.tab('show');


   function toggleChevron(e) {
     $(e.target)
        .prev('.panel-heading')
        .find('i.indicator')
        .toggleClass('glyphicon-chevron-down glyphicon-chevron-up');
   }
   $('#accordion').on('hidden.bs.collapse', toggleChevron);
   $('#accordion').on('shown.bs.collapse', toggleChevron);
 });

</script>


{% endblock %}

