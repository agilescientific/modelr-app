{% extends "base_template.html" %} 
{% block title %}Modelr &middot;Â Scenario{% endblock %} 

{% block content %}
<style>
img.img-thumbnail {
    border-style:hidden;
    -webkit-box-shadow: none;
            box-shadow: none;
}

#loader{
   height:400px;
   width:400px;
   position:center;
   display:none;
}
</style>

<div class="container">

  {% if error %}
  <div class="alert alert-danger">
      <strong>Something's wrong...</strong> {{ error }}
  </div>
  {% endif %}

  {% if warning %}
  <div class="alert alert-warning">
      <strong>Sorry...</strong> {{ warning }} 
  </div>
  {% endif %}

  {% if success %}
  <div class="alert alert-success">
      <strong>Success!</strong> {{ success }} 
  </div>
  {% endif %}
  

  <!-- SCENARIO PANEL
  ================================================================ -->
  <div class="row">

    <div class="col-md-6">
      <div class="panel panel-primary">
	<div class="panel-heading">
          <h3 class="panel-title">Scenario</h3>
	</div>
	
	<div class="panel-body">
	  
	  <form class="form-horizontal" role="form">
            
	    {% if not user %}
	    
	    <div class="alert alert-warning" 
		 style="margin-bottom: 35px" >
	      <strong>Demo mode.</strong> <a href="/signup">
		Sign up
	      </a> 
	      to create rocks and save scenarios!
	    </div>
	    {% endif %}

            
              <div class="form-group">
		<div class="form-inline">
		  <label for="scenario_loader" 
			 class="col-sm-3 control-label">Load scenario
		  </label>
		  <div class="col-sm-7">
		    <select  class="form-control" 
			     id='scenario_loader' 
			     onchange="load_scenario(this.value);" 
			     placeholder="scenario name">
		      <option value="" selected hidden disabled >
			Scenarios
		      </option>
		      {% for scenario in scenarios %}
		      <option value="{{scenario.name}}"> 
			{{scenario.name}}
		      </option>
		      {% endfor %}
		    </select>
		  </div>
		  
		</div>
              </div>
              
              
	      {% if not user %}<fieldset disabled>{% endif %}
              <div class="form-group">
		<div class="form-inline">
		  <label for="select_script" 
			 class="col-sm-3 control-label" {% if not user %} style="color:gray;"{% endif %}>
		    Select script
		  </label>
		  <div class="col-sm-7">
		    <select class="form-control" 
			    id="select_script" {% if not user %}style="background-color:#bbb;" {% endif %}
			    onchange="scenario.set_current_script(
			    $(this).val(), scenario.arguments)">
		      <option>Please wait... </option>
		    </select>
		  </div>
		</div>
              </div>
	      {% if not user %}</fieldset>{% endif %}
              <!-- Div to place the form into see Scenario.display 
	      and display_form functions-->
              <div class="container" id="scenario_place">
              </div>
              
              <hr/>
              
              <div class="form-group">
		<div class="col-sm-offset-3 col-sm-4">
		  <button class="btn btn-primary" 
			  id='create_image' 
			  onclick="server.update_img(scenario)"
			  type="button">
		    Update Plot
		  </button>
		</div>
              </div>

              {% if not user %}<fieldset disabled>{% endif %}
		<div class="form-group">

		  <div class="form-inline">
		    <label for="scenario_name" 
			   class="col-sm-3 control-label"{% if not user %} style="color:gray;"{% endif %}>
		      Save scenario
		    </label>
		    <div class="col-sm-7">
		      <input {% if not user %}style="background-color:#bbb;" {% endif %}class="form-control" 
			     id='scenario_name' 
			     onchange="scenario.name = this.value;" 
			     placeholder="scenario name" 
			     maxlength="20">
		      </input>
		    </div>
		    <div class="col-md-offset-10">
		      <button class="btn btn-default" 
			      onclick="save_scenario()"
			      type="button" id="savebutton">
			save
		      </button>
		    </div>

		  </div>
		</div>
		{% if not user %}</fieldset>{% endif %}

	  </form>

	</div>  <!-- end of panel-body -->
      </div>
    </div>
    
    <!-- RESULT PANEL============================================ -->

    <div class="col-md-6">
      <div class="panel panel-default">
	<div class="panel-heading">
          <h3 class="panel-title">Result</h3>
	</div>
	<div class="panel-body">

          <img class="img-thumbnail" id="plot_image" href=URL 
	       alt="" src="/static/img/placeholder_model_image.png">
	  <span id="loader"><img src="/static/img/ajax-loader.gif"></span>
          <!-- Updated by the  create_image button above-->
          </img>

	</div>
      </div>
    </div>

  </div>

</div>

<!-- JAVASCRIPT and DATA
================================================================ -->

<script>
 var host = '{{HOSTNAME}}';
</script>

<script>

 $(document).ready(function() {
   
   server = new PlotServer(host, 
			   get_rocks('datalist#list_of_rocks'));
   scenario = new Scenario(name, null, {}, server.rocks);
   
   // This is specific to this page. will create a form.
   scenario.display = display_form;
   
   // This is specific to this page.
   // Used by the script select element + 
   // the get method of Scenario.
   scenario.set_current_script = function(value, argumentss){

     scenario.script = value;
     
     console.log('server.current_script');
     
     server.get_script_info(value, function(data){
       scenario.info = data;
       scenario.default_args(argumentss);
       
       console.log('div#scenario_place');
       
       // This will Create a form see above
       scenario.display('div#scenario_place');
       
       scenario.on_change();

       if (!$.isEmptyObject(argumentss)) {      
       server.update_img(scenario);}
   
     })
     
     // Select the script in the 'select' element of this 
     // page.  
     $("select#select_script option").filter(function() {
       //may want to use $.trim in here
       return $(this).val() == value; 
     }).attr('selected', true);

   }
   
   // This is specific to this display.
   server.update_img = function(scenario){
     
     var img = $('img#plot_image');
     var loader = $('#loader');
     var qs = scenario.qs();
     var url = server.hostname +'/plot.jpeg' + qs;
     
     img.attr('src','');
     loader.show();
     img.attr('src', url).load(function(){
       loader.fadeOut();
     });

     $.post('/model_served');
     
   }
   
   scenario.on_change = function update_link(){
     
     var qs = scenario.qs();
     var url = server.hostname +'/plot.jpeg' + qs;
     
     var p = $('p#image_link');
     p.text(url);
   }
   
   /* 
   This populates the scripts dropdown with a list of scripts
   from the plot server.
    */
   populate_scripts(server, 'select#select_script');

   /*
   This grabs the data after the '#' in the url and updates the 
   current scenario.
    */
   var hash = window.location.hash.substring(1);
   
   if (hash != ''){
     scenario.name = hash;
     
     // Get the scenario from google app engine.
     scenario.get();
     $('input#scenario_name').val(hash);
     server.update_img(scenario);
   }
   
   // Updates the scenario loader and then puts the scenario in the
   // database
   save_scenario = function save_scenario(){
     
     loader = $("#scenario_loader")

     // Changes the button text and colour to signal success 
     // (reset by function below)
     $("#savebutton").html("saved").removeClass("btn-default").addClass("btn-success");
     // Check for duplicates
     
     loader.append("<option value=" + scenario.name + 
		   "id=" + scenario.name + ">"+
		   scenario.name + "</option>");
    
     var usedNames = {};
     $("select[id='scenario_loader'] > option").each(function () {
       if(usedNames[this.text]) {
         $(this).remove();
       } else {
         usedNames[this.text] = this.value;
       }
     });
     scenario.put();
     
     // Changes the button text and colour to signal success 
     // (reset by function below)
     $("#savebutton").html("saved").removeClass("btn-default").addClass("btn-success");
     
   }
 });
 
 // Watch for changes in the form, to reset the 'save' button styling (see above)
 $("form").change(function() {
   $("#savebutton").html("save").removeClass("btn-success").addClass("btn-default");
 });
 
 // Watch for changes in the scenario dropdown, to reset the 'load' button styling
 $("#scenario_loader").change(function() {
   $("#load_button").removeClass("btn-default").addClass("btn-success");
 });
 
 // Reverts the button colour to after loading
 $("#load_button").click(function() {
   $("#load_button").removeClass("btn-success").addClass("btn-default");
 });
     


 // Loads a scenario
 load_scenario = function load_scenario(scenario_name){

   scenario.name = scenario_name;
   scenario.get();
}
 
</script>



<!-- This will expand the list of rocks before google app engine 
sends this page to the user -->
<!-- This list is used by javascript and not directly seen 
by the user -->
<datalist id="list_of_rocks">

  {% for rock in rocks %}
  <option data-value="{{rock.vp}},{{rock.rho}},{{rock.vs}},
	  {{rock.vp_std}}, {{rock.vs_std}}, {{rock.rho_std}}"
	  data-name="{{rock.name}}">{{rock.name}}</option>
  {% endfor %}
  {% for group in group_rocks %}
  {% for rock in group.rocks %}
  <option data-value="{{rock.vp}},{{rock.rho}},{{rock.vs}},
	  {{rock.vp_std}}, {{rock.vs_std}}, {{rock.rho_std}}"
	  data-name="{{rock.name}}">
    {{rock.name}}
  </option>
  {% endfor %}
  {% endfor %}
  {% for rock in default_rocks %}
  <option data-value="{{rock.vp}},{{rock.rho}},{{rock.vs}},
	  {{rock.vp_std}}, {{rock.vs_std}}, {{rock.rho_std}}"
	  data-name="{{rock.name}}">{{rock.name}}
  </option>
  {% endfor %}
  
</datalist>


{% endblock %}
